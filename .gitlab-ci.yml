### DO NOT EDIT THIS FILE ###
### --------------------- ###
### CONFIG FILE FOR TEST  ###
### PLEASE IGNORE         ###


# Docker image enviroment 
image: ubuntu:latest

# Only one stage to test and push results
stages:
    - test

test:
  stage: test
  allow_failure: true
  only:
    variables:
      - $CI_COMMIT_MESSAGE =~ /test me pls/
  script:
    # Setting up the enviroment
    - apt-get update -y
    - apt-get install git -y
    # set noninteractive installation
    - export DEBIAN_FRONTEND=noninteractive
    # install tzdata package
    - apt-get install -y tzdata
    # set your timezone
    - ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime
    - dpkg-reconfigure --frontend noninteractive tzdata
    # Install autograder dependencies
    - apt-get install python3-pip -y
    - apt-get install valgrind -y
    - pip3 install pandas && pip3 install numpy
    - pip3 install matplotlib
    # Make directory for student files and clone into it as well as autotest files
    - mkdir autograder && cd autograder
    # Update autotest repo name here
    - git clone http://${GRADER_USERNAME}:${GRADER_ACCESS_TOKEN}@${CI_SERVER_HOST}/2022-SP-CS1575/pa04-ci-autotest .
    - mkdir hw
    - cd hw
    - mkdir $GITLAB_USER_LOGIN
    - cd $GITLAB_USER_LOGIN
    - git clone -b "${CI_COMMIT_BRANCH}" http://${GRADER_USERNAME}:${GRADER_ACCESS_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git .
    - cd ../..
    - python3 autograder_pa04.py hw
    - cd hw/$GITLAB_USER_LOGIN
    - mv ../../processResults.py ./
    - python3 processResults.py
    - mv results.txt ../../../
    # Set up Grader gitlabs info here for pushing
    - git config --global user.name "${GRADER_USERNAME}"
    - git config --global user.email "${GRADER_EMAIL}"
    - git add TestResults.txt
    - git add results.csv
    - git commit --allow-empty -m "Tested"
    # Set up enviroment variables here in settings > CI/CD > variables: Needed for pushing to student repo
    # NOTE: only pushes to student repo if he/she started the job (commit/push) also skips the pipeline
    - git push "http://${GRADER_USERNAME}:${GRADER_ACCESS_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
   
  artifacts:
    paths:
      - results.txt
    expire_in: 3 week

